generator client {
  provider      = "prisma-client-js"
  previewFeatures = ["driverAdapters"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id            String   @id @default(cuid())
  handle        String   @unique
  email         String   @unique
  name          String?
  image         String?
  githubId      String?  @unique
  headline      String?
  skills        String[]
  role          UserRole @default(USER)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  posts         Post[]
  projects      Project[]
  jamsHosted    Jam[]    @relation("JamHost")
  follows       Follow[] @relation("Follower")
  followers     Follow[] @relation("Followee")
  transactions  Transaction[] @relation("Buyer")
  sales         Transaction[] @relation("Seller")
  interactions  PostInteraction[]
  marketplaceItems MarketplaceItem[] @relation("MarketplaceSeller")
  
  // Direct Messaging
  sentMessages      Message[] @relation("MessageSender")
  conversationParticipants ConversationParticipant[]
  
  // Mentions
  mentions          Mention[] @relation("MentionedUser")
  createdMentions   Mention[] @relation("MentionCreator")
}

enum UserRole {
  USER
  ADMIN
}

model Project {
  id          String   @id @default(cuid())
  ownerId     String
  owner       User     @relation(fields: [ownerId], references: [id])
  title       String
  githubUrl   String   @unique
  tags        String[]
  summary     String?
  embedding   Embedding?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Post {
  id          String   @id @default(cuid())
  authorId    String
  author      User     @relation(fields: [authorId], references: [id])
  type        PostType
  content     Json
  viewCount   Int      @default(0)
  trendingScore Float  @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  interactions PostInteraction[]
  mentions    Mention[]
}

enum PostType {
  REPO_CARD
  CLIP
  NOTE
}

model Follow {
  id         String @id @default(cuid())
  followerId String
  followeeId String
  follower   User   @relation("Follower", fields: [followerId], references: [id])
  followee   User   @relation("Followee", fields: [followeeId], references: [id])

  @@unique([followerId, followeeId])
}

model Jam {
  id        String   @id @default(cuid())
  hostId    String
  host      User     @relation("JamHost", fields: [hostId], references: [id])
  roomId    String   @unique
  startedAt DateTime @default(now())
  endedAt   DateTime?
}

model MarketplaceItem {
  id          String   @id @default(cuid())
  sellerId    String
  seller      User     @relation("MarketplaceSeller", fields: [sellerId], references: [id])
  title       String
  description String
  type        ItemType
  priceCents  Int
  tags        String[]
  previewUrl  String?
  downloadUrl String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  transactions Transaction[]
}

enum ItemType {
  TEMPLATE
  SNIPPET
  CONSULTING
  COURSE
}

model Transaction {
  id        String   @id @default(cuid())
  buyerId   String
  buyer     User     @relation("Buyer", fields: [buyerId], references: [id])
  sellerId  String
  seller    User     @relation("Seller", fields: [sellerId], references: [id])
  itemId    String
  item      MarketplaceItem @relation(fields: [itemId], references: [id])
  priceCents Int
  status     TxStatus @default(PENDING)
  createdAt  DateTime @default(now())
}

enum TxStatus {
  PENDING
  PAID
  REFUNDED
  FAILED
}

model Embedding {
  projectId String  @id
  project   Project @relation(fields: [projectId], references: [id])
  vector    Unsupported("vector")
}

model PostInteraction {
  id        String          @id @default(cuid())
  postId    String
  post      Post            @relation(fields: [postId], references: [id], onDelete: Cascade)
  userId    String
  user      User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  kind      InteractionKind
  content   String?         // For COMMENT type
  createdAt DateTime        @default(now())
  
  @@unique([postId, userId, kind])
  @@index([postId])
  @@index([userId])
}

enum InteractionKind {
  LIKE
  BOOKMARK
  COMMENT
}

// Direct Messaging
model Conversation {
  id          String   @id @default(cuid())
  isGroup     Boolean  @default(false)
  name        String?  // For group chats
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  participants ConversationParticipant[]
  messages     Message[]
}

model ConversationParticipant {
  id             String   @id @default(cuid())
  conversationId String
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  userId         String
  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  lastReadAt     DateTime?
  joinedAt       DateTime @default(now())
  
  @@unique([conversationId, userId])
  @@index([userId])
}

model Message {
  id             String   @id @default(cuid())
  conversationId String
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  senderId       String
  sender         User     @relation("MessageSender", fields: [senderId], references: [id], onDelete: Cascade)
  content        String
  type           MessageType @default(TEXT)
  metadata       Json?    // For code snippets, links, etc.
  isEdited       Boolean  @default(false)
  isDeleted      Boolean  @default(false)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  
  @@index([conversationId])
  @@index([senderId])
}

enum MessageType {
  TEXT
  CODE
  IMAGE
  LINK
}

// Mentions System
model Mention {
  id         String   @id @default(cuid())
  postId     String?
  post       Post?    @relation(fields: [postId], references: [id], onDelete: Cascade)
  commentId  String?  // Reference to PostInteraction with kind=COMMENT
  mentionedUserId String
  mentionedUser   User @relation("MentionedUser", fields: [mentionedUserId], references: [id], onDelete: Cascade)
  createdById     String
  createdBy       User @relation("MentionCreator", fields: [createdById], references: [id], onDelete: Cascade)
  notified        Boolean @default(false)
  createdAt       DateTime @default(now())
  
  @@index([mentionedUserId])
  @@index([postId])
}

